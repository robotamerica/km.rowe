<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>blog – km.rowe</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=VT323&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    .blog-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      padding: 2rem;
    }

    .categories {
      flex: 1 1 180px;
    }

    .categories ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .categories li {
      margin-bottom: 0.5rem;
    }

    .categories a {
      cursor: pointer;
      display: block;
    }

    .categories select {
      margin-top: 1rem;
      width: 100%;
      font-family: 'IBM Plex Mono', monospace;
      background: black;
      color: inherit;
      border: 1px solid currentColor;
      padding: 0.4rem;
    }

    .posts {
      flex: 3 1 600px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      width: 100%;
    }

    .post-card {
      background: black;
      border: 2px solid currentColor;
      padding: 1rem;
      font-family: 'IBM Plex Mono', monospace;
      cursor: grab;
      transition: transform 0.2s;
      width: 100%;
      box-sizing: border-box;
    }

    .post-card:hover {
      transform: scale(1.02);
    }

    .post-card h3 {
      margin-top: 0;
    }

    .post-card p {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body class="alt-mode">
  <div class="scanlines"></div>
  <header>
    <div class="logo blinking-cursor">km.rowe</div>
    <nav>
      <a href="index.html">home</a>
      <a href="chapbooks.html">chapbooks</a>
      <a href="blog.html">blog</a>
      <a href="links.html">links</a>
    </nav>
    <button class="toggle-mode" onclick="toggleCRT()" id="modeToggle">green mode</button>
  </header>

  <audio id="click-sound" src="assets/click.wav" preload="auto"></audio>

  <main class="blog-layout">
    <aside class="categories">
      <h2>categories</h2>
      <ul id="category-list"></ul>
      <label for="sortSelect">sort by:</label>
      <select id="sortSelect" onchange="sortPosts(this.value)">
        <option value="desc">date ↓</option>
        <option value="asc">date ↑</option>
      </select>
    </aside>
    <section class="posts" id="post-grid"></section>
  </main>

  <script>
    (async function () {
  const grid = document.getElementById('post-grid');
  if (!grid) {
    console.warn('Missing #post-grid in blog.html');
    return;
  }

  let allPosts = [];
  try {
    const res = await fetch('posts/posts.json', { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.json();

    // Normalize to .html (you removed the .md sources) and de-dupe by file
    const byKey = new Map();
    raw.forEach(p => {
      const htmlName = String(p.file || '').replace(/\.md$/i, '.html');
      const key = htmlName.toLowerCase();
      byKey.set(key, { ...p, file: htmlName });
    });

    allPosts = Array.from(byKey.values())
      .sort((a, b) => new Date(b.date) - new Date(a.date));
  } catch (err) {
    console.error('Failed to load posts.json:', err);
    grid.innerHTML = '<p>Unable to load posts right now.</p>';
    return;
  }

  const urlFor = (p) => encodeURI(`posts/${p.file}`);

  const cardFor = (p) => {
    const card = document.createElement('div');
    card.className = 'post-card';
    card.dataset.category = (p.category || '').toLowerCase();

    const dateStr = p.date ? new Date(p.date).toLocaleDateString() : '';
    const url = urlFor(p);

    card.innerHTML = `
      <h3><a class="post-link" href="${url}">${p.title}</a></h3>
      <time>${dateStr}</time>
      <p>${p.description || ''}</p>
    `;

    // Make the whole card clickable, but don't double-trigger if the <a> is clicked
    card.addEventListener('click', (e) => {
      if (!(e.target instanceof HTMLAnchorElement)) {
        window.location.href = url;
      }
    });

    return card;
  };

  function render(list) {
    grid.innerHTML = '';
    list.forEach(p => grid.appendChild(cardFor(p)));
  }

  render(allPosts);

  // Optional: live search (if you have an #search input)
  const search = document.getElementById('search');
  if (search) {
    search.addEventListener('input', () => {
      const q = search.value.toLowerCase();
      const filtered = allPosts.filter(p =>
        (p.title || '').toLowerCase().includes(q) ||
        (p.description || '').toLowerCase().includes(q) ||
        (p.category || '').toLowerCase().includes(q)
      );
      render(filtered);
    });
  }

  // Optional: category filter (if you have a #categories container with [data-filter] buttons)
  const categories = document.getElementById('categories');
  if (categories) {
    categories.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-filter]');
      if (!btn) return;
      const f = btn.getAttribute('data-filter');
      const list = (f === 'all')
        ? allPosts
        : allPosts.filter(p => (p.category || '').toLowerCase() === f.toLowerCase());
      render(list);
    });
  }
})();
  </script>
<script src="mode.js"></script>

</body>
</html>

