<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>notes – km.rowe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Site styles + fonts -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=VT323&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    /* ── Filters (tag buttons) ───────────────────────────── */
    .notes-filters {
      display: flex; gap: .5rem; flex-wrap: wrap;
      padding: 1rem 2rem 0 2rem;
    }
    .notes-filters button {
      background: transparent;
      border: 1px solid currentColor;
      color: inherit;
      cursor: pointer;
      font-family: "IBM Plex Mono", monospace;
      padding: .35rem .8rem;
      transition: transform .12s ease, background-color .12s ease, color .12s ease, border-color .12s ease;
    }
    .notes-filters button:hover,
    .notes-filters button:focus-visible {
      transform: scale(1.03);
      outline: none;
    }
    /* Active state tuned per mode for contrast */
    body.alt-mode .notes-filters button.is-active,
    body.crt-mode .notes-filters button.is-active {
      background: currentColor;
      color: #000;         /* cyan/green on black → black text for contrast */
      border-color: currentColor;
      text-shadow: none;
    }
    body.epaper-mode .notes-filters button {
      background: #fff;           /* subtle button fill on epaper */
      color: #1a1a1a;
      border-color: #444;
    }
    body.epaper-mode .notes-filters button.is-active {
      background: #1a1a1a;        /* dark active */
      color: #fbfbf8;             /* light text */
      border-color: #1a1a1a;
    }

    /* ── Grid/table layout for notes ─────────────────────── */
    .notes-wrap { padding: 1rem 2rem 2rem 2rem; }
    .notes-grid {
      display: grid;
      grid-template-columns: 140px 1fr 160px; /* Date | Entry | Format */
      gap: 8px;
      align-items: start;
    }
    .notes-row { display: contents; }
    .notes-cell {
      border: 1px dashed currentColor;
      padding: .6rem .8rem;
      word-break: break-word;
      background: black; /* matches site dark bg in alt/crt */
    }
    .notes-heading .notes-cell { font-weight: bold; }

    /* E-paper adjustments (harmonize with your epaper mode) */
    body.epaper-mode .notes-cell {
      background: #fbfbf8;
      border-color: #aaa;
    }

    /* Responsive stack */
    @media (max-width: 760px) {
      .notes-grid { grid-template-columns: 1fr; }
      .notes-cell { border-left-width: 2px; }
    }
  </style>

  <!-- Optional Markdown rendering for entry text -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="alt-mode">
  <div class="scanlines"></div>

  <header>
    <div class="logo blinking-cursor">km.rowe</div>
    <nav>
      <a href="index.html">home</a>
      <a href="chapbooks.html">chapbooks</a>
      <a href="notes.html">notes</a>
      <a href="links.html">links</a>
    </nav>
    <button class="toggle-mode" id="modeToggle">green mode</button>
  </header>

  <div class="notes-filters" id="filters">
    <button data-filter="all" class="is-active">👀 all</button>
    <button data-filter="notes">📝 notes</button>
    <button data-filter="reading">📚 reading</button>
    <button data-filter="tools">🔧 tools</button>
    <button id="randomBtn">🎲 random</button>
  </div>

  <main class="notes-wrap">
    <div class="notes-grid" id="notesGrid" aria-live="polite">
      <div class="notes-row notes-heading">
        <div class="notes-cell">Date</div>
        <div class="notes-cell">Entry</div>
        <div class="notes-cell">Format</div>
      </div>
      <!-- rows injected here -->
    </div>
  </main>

  <script>
    (async () => {
      const grid = document.getElementById('notesGrid');
      const filters = document.getElementById('filters');
      const randomBtn = document.getElementById('randomBtn');
      marked.setOptions({ breaks: true });

      let items = [];
      try {
        const res = await fetch('notes.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        items = await res.json();
      } catch (err) {
        console.error(err);
        grid.insertAdjacentHTML('beforeend',
          '<div class="notes-row"><div class="notes-cell" style="grid-column:1/-1">Could not load notes.json</div></div>');
        return;
      }

      // newest first
      items.sort((a,b) => new Date(b.date||0) - new Date(a.date||0));

      const row = (note) => {
        const date = note.date ? new Date(note.date).toLocaleDateString() : '';
        const tag  = (note.tag || '').toLowerCase();
        const fmt  = note.format || '';
        const entryHtml = marked.parse(String(note.entry || ''));
        return `
          <div class="notes-row" data-tag="${tag}">
            <div class="notes-cell">${date}</div>
            <div class="notes-cell">${entryHtml}</div>
            <div class="notes-cell">${fmt}</div>
          </div>`;
      };

      function render(list) {
        // Remove previous rows (keep heading)
        Array.from(grid.querySelectorAll('.notes-row:not(.notes-heading)')).forEach(n => n.remove());
        if (!list.length) {
          grid.insertAdjacentHTML('beforeend',
            '<div class="notes-row"><div class="notes-cell" style="grid-column:1/-1">No notes.</div></div>');
          return;
        }
        grid.insertAdjacentHTML('beforeend', list.map(row).join(''));
      }

      function setActive(btn) {
        filters.querySelectorAll('button[data-filter]').forEach(b => b.classList.remove('is-active'));
        if (btn) btn.classList.add('is-active');
      }

      function applyFilter(tag) {
        if (tag === 'all') { render(items); return; }
        render(items.filter(n => (n.tag || '').toLowerCase() === tag));
      }

      // Initial render
      render(items);

      // Click handlers: filter buttons
      filters.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-filter]');
        if (!btn) return;
        const tag = btn.dataset.filter;
        setActive(btn);
        applyFilter(tag);
      });

      // Random note
      randomBtn.addEventListener('click', () => {
        if (!items.length) return;
        const pick = items[Math.floor(Math.random() * items.length)];
        setActive(null); // clear active filter
        render([pick]);
      });
    })();
  </script>

  <script src="mode.js"></script>
</body>
</html>
